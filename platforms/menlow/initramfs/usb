# Live USB filesystem mounting			-*- shell-script -*-

mountroot ()
{
    mkdir -p /container
    mkdir -p /squashmnt
    mkdir -p /persistmnt

#find USB boot dongle
    while true; do
      for driver in 'sda' 'sdb' 'sdc' 'sdd'; do
        echo "checking driver $driver"
        if [ -e /sys/block/$driver/removable ]; then
           if [ "$(cat /sys/block/$driver/removable)" = "1" ]; then
              echo "found usb dongle at $driver"
	      found="yes"
              break
           fi
         fi
      done
      if [ "$found" = "yes" ]; then
	break;
      fi
      /bin/sleep 5
    done
    echo "will mount root from $driver"

    mount /dev/$driver /container 2> /dev/null
    while [ ! -e "/container/rootfs.img" ]; do
	/bin/sleep 0.5
	mount /dev/$driver /container 2> /dev/null
    done

    mount -o loop -t squashfs /container/rootfs.img /squashmnt

    if [ -f /container/ext3fs.img ]; then
        mount -o loop /container/ext3fs.img /persistmnt
    else
        mount -t tmpfs none /persistmnt
    fi

    mount -t unionfs -o dirs=/persistmnt=rw:/squashmnt=ro none ${rootmnt}

    if [ -f /container/install.sh ]; then
	 log_begin_msg "Install Process will begin shortly..."
	 maybe_break preinstall

	 mkdir -p ${rootmnt}/tmp/install
	 mount --bind /dev ${rootmnt}/dev
	 #udev currently don't know we will partition HD to 2 parts, and we don't use mount --bind ...
	 mknod /dev/sda1 b 8 1
	 mknod /dev/sda2 b 8 2
	 mknod /dev/hda1 b 3 1
	 mknod /dev/hda2 b 3 2
	 cp -a /dev/* ${rootmnt}/dev 2> /dev/null
	 mount --bind /sys ${rootmnt}/sys
	 mount -t sysfs sys ${rootmnt}/sys
	 mount --bind /container ${rootmnt}/tmp/install
	 mount /dev/$driver ${rootmnt}/tmp/install
	 cp /container/install.sh ${rootmnt}

	 maybe_break install
	 chroot ${rootmnt} /install.sh
    fi
}
